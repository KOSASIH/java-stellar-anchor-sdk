version: '2.4'
services:
  anchor-platform-server:
    image: anchor-platform
    command: "--sep-server"
    environment:
      - stellar.anchor.config=file:/config/anchor-platform-config.yaml
      - secret.sep10.signing_seed=SAX3AH622R2XT6DXWWSRIDCMMUCCMATBZ5U6XKJWDO7M2EJUBFC3AW5X
      - secret.sep10.jwt.secret=secret
      - secret.sep10.api.auth.secret=myAnchorToPlatformSecret
      - secret.callback.api.auth.secret=myPlatformToAnchorSecret
      - secret.data.username=postgres
      - secret.data.password=password
    volumes:
      # add mounts for the new config directory
      - ./anchor-platform-default-configs:/config_default
    tmpfs:
      - /config
    depends_on:
      - db
      - kafka
    extra_hosts:
      - "host.docker.internal:host-gateway"

  stellar-observer:
    image: anchor-platform
    extends:
      file: ../docker-compose/common-services/common-services.yaml
      service: observer_a
    environment:
      - stellar.anchor.config=file:/config/anchor-platform-config.yaml
      - secret.sep10.signing_seed=SAX3AH622R2XT6DXWWSRIDCMMUCCMATBZ5U6XKJWDO7M2EJUBFC3AW5X
      - secret.sep10.jwt.secret=secret
      - secret.platform.api.auth.secret=myAnchorToPlatformSecret
      - secret.callback.api.auth.secret=myPlatformToAnchorSecret
      - secret.data.username=postgres
      - secret.data.password=password

  anchor-reference-server:
    extends:
      file: ../docker-compose/common-services/common-services.yaml
      service: reference_server_a

  kafka:
    extends:
      file: ../docker-compose/common-services/common-services.yaml
      service: kafka_a

  zookeeper:
    extends:
      file: ../docker-compose/common-services/common-services.yaml
      service: zookeeper_a

  db:
    extends:
      file: ../docker-compose/common-services/common-services.yaml
      service: db_a

  end-to-end-tests:
    build:
      context: ..
      dockerfile: Dockerfile
    depends_on:
      - anchor-platform-server
      - anchor-reference-server
    environment:
      - E2E_SECRET=${E2E_SECRET?err}
    extra_hosts:
      - "host.docker.internal:host-gateway"
